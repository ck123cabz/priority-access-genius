# Story 2.4: PDF Generation Service (Edge Function)

## Status

Done

## Story

**As a** System,
**I want** a serverless function that generates a PDF from an agreement,
**so that** the logic is scalable and decoupled.

## Acceptance Criteria

1. A Supabase Edge Function accepts an `agreementId`
2. It fetches data, composes a PDF, and saves it to Supabase Storage

## Tasks / Subtasks

- [x] Create Supabase Edge Function structure (AC: 1)
  - [x] Set up function directory at `supabase/functions/generate-pdf`
  - [x] Create main function handler with proper CORS handling
  - [x] Add TypeScript imports and interfaces for Edge Function runtime
  - [x] Implement request validation for agreementId parameter
  - [x] Add authentication check for valid Supabase JWT token

- [x] Implement agreement data fetching (AC: 1)
  - [x] Create Prisma client connection for Edge Function environment
  - [x] Implement agreement retrieval by ID with client relationship
  - [x] Add data validation and error handling for missing agreements
  - [x] Fetch related client data for PDF template population
  - [x] Add proper error logging for debugging

- [x] Build PDF composition logic (AC: 2)
  - [x] Research and integrate PDF generation library compatible with Deno runtime
  - [x] Create PDF template with client company name, contact details
  - [x] Add signature section with signer name, IP, timestamp
  - [x] Include terms version and legal content structure
  - [x] Add professional formatting and layout design

- [x] Implement Supabase Storage integration (AC: 2)
  - [x] Configure connection to `agreements` storage bucket
  - [x] Generate unique filename using agreement ID and timestamp
  - [x] Upload generated PDF with proper metadata and content type
  - [x] Update Agreement record with generated pdf_url using transaction
  - [x] Handle storage errors and cleanup on failures

- [x] Add comprehensive error handling (AC: 1, 2)
  - [x] Implement timeout protection for long-running operations
  - [x] Add retry logic for transient database/storage failures
  - [x] Create structured error responses with proper HTTP status codes
  - [x] Add detailed logging for production debugging
  - [x] Handle edge cases like invalid agreement states

- [x] Unit tests for PDF generation logic (Testing Standards)
  - [x] Test successful PDF generation with valid agreement data
  - [x] Test error handling for missing/invalid agreement IDs
  - [x] Test authentication validation and unauthorized access
  - [x] Test PDF content includes all required signature details
  - [x] Test storage upload and database update transaction
  - [x] Test timeout handling and retry mechanisms
  - [x] Mock Supabase clients for isolated testing

## Dev Notes

### Previous Story Insights

Story 2.3 successfully implemented signature persistence with comprehensive validation, error handling, and atomic database transactions. The Agreement records now contain all necessary data (signer_name, signer_ip, signed_at, signature_hash, client relationship) that will be used for PDF generation. The server action pattern and repository layer provide a solid foundation for the Edge Function to fetch agreement data reliably.

### Data Models

[Source: architecture/4-data-models.md]
**Agreement Model:** The Edge Function will access Agreement data including:
- `id`: string (UUID) - Unique identifier passed as agreementId parameter
- `client_id`: string (UUID) - Foreign key to fetch related Client data
- `terms_version`: string - Version of legal terms for PDF header
- `signed_at`: Date - Signature timestamp for PDF documentation
- `signer_name`: string - Full name for signature section
- `signer_ip`: string - IP address for audit trail in PDF
- `signature_hash`: string - Data integrity verification
- `pdf_url`: string | null - Will be updated after PDF generation

**Client Model:** Related client data needed for PDF:
- `company_name`: string - Company name for PDF header/title
- `contact_name`: string - Primary contact for PDF addressing
- `email`: string - Contact email for PDF documentation
- `role_title`: string - Contact title for professional addressing
- `logo_url`: string | null - Company logo for PDF branding

### API Specifications

[Source: architecture/5-api-specification.md]
**PDF Generation Endpoint:**
- **Endpoint:** `POST /functions/v1/generate-pdf`
- **Auth:** Supabase user JWT required for security
- **Request Body:** `{ "agreementId": "uuid" }`
- **Success Response:** `{ "pdfUrl": "https://.../agreements/..." }`
- **Error Response:** `{ "error": "PDF generation failed", "details": "..." }`

**Primary Data Access:** Use Supabase JavaScript Client SDK with Prisma-generated types for end-to-end type safety when fetching Agreement and Client data.

### Database Schema

[Source: architecture/9-database-schema-prisma.md]
**Agreement Query Pattern:**
```prisma
// Edge Function will query with client relationship
agreement = await prisma.agreement.findUnique({
  where: { id: agreementId },
  include: { client: true }
})
```

**Database Update:** After PDF generation, update Agreement record:
```prisma
await prisma.agreement.update({
  where: { id: agreementId },
  data: { pdf_url: generatedPdfUrl }
})
```

### Backend Architecture

[Source: architecture/11-backend-architecture-selected-highlights.md]
**Supabase Edge Function:** Follow Edge Function template pattern with:
- Shared `cors.ts` utility for CORS handling
- Repository pattern for Prisma access within Edge Function
- Function template with JSON responses and proper error handling

**Storage Integration:** Use Supabase Storage for PDF persistence in the `agreements` bucket with private access and signed URLs.

### File Locations

[Source: architecture/12-unified-project-structure.md]
Based on the monorepo structure:
```
supabase/
  functions/
    generate-pdf/
      index.ts                         # New: main Edge Function handler
      pdf-generator.ts                 # New: PDF composition logic
      agreement-service.ts             # New: data fetching service
    shared/
      cors.ts                          # New: shared CORS utility
packages/
  types/
    pdf-generation.ts                  # New: PDF-specific TypeScript interfaces
```

### Technical Constraints

[Source: architecture/3-tech-stack.md]
- **Edge Function Runtime:** Deno environment for Supabase Edge Functions
- **Backend Language:** TypeScript with Deno-compatible imports
- **ORM:** Prisma ~5.15 for type-safe database access in Edge Function
- **Database:** PostgreSQL 15.1 via Supabase
- **File Storage:** Supabase Storage with `agreements` bucket (private access)
- **PDF Library:** Must be Deno-compatible (research required for specific library)

### Security Requirements

[Source: architecture/17-coding-standards.md]
**Authentication:** Validate Supabase user JWT token before processing requests
**Service Layer Pattern:** Use repository pattern for database access, no direct Prisma calls in main handler
**Private Storage:** PDFs stored in private `agreements` bucket, accessible only via signed URLs
**Input Validation:** Comprehensive validation of agreementId parameter and request structure

### Core Workflow Integration

[Source: architecture/8-core-workflows.md]
This story implements the PDF generation step in **Workflow 2: Client Activates Agreement**:
```
App->>PDF: Invoke generate-pdf (Story 2.4 - This Story)
PDF->>Storage: Save PDF
Storage-->>PDF: Return pdf_url  
PDF->>DB: Update agreement with pdf_url
PDF-->>App: Success
```

The Edge Function ensures:
1. Agreement data is fetched securely with client relationship
2. PDF is generated with all signature and client details
3. PDF is stored in private storage with proper access controls
4. Agreement record is updated with pdf_url for download access
5. Success/error status is returned for proper UI feedback

### Project Structure Notes

The Supabase Edge Function will integrate with the existing signature persistence from Story 2.3, accessing Agreement records created by the server action. The function follows the established repository pattern and uses the same TypeScript interfaces from the `packages/types` workspace for consistency across the monorepo.

## Testing

### Testing Standards

[Source: architecture/16-testing-strategy.md]
- **Testing Framework:** Deno testing framework for Edge Function unit tests
- **Test File Location:** `supabase/functions/generate-pdf/__tests__/` following Edge Function patterns
- **Setup:** Deno test configuration for Edge Function environment

**Test Types Required:**
- Unit tests for PDF generation logic and data fetching
- Integration tests for Supabase Storage upload and database updates
- Authentication tests for JWT validation and unauthorized access
- Error handling tests for various failure scenarios
- Mock tests for Prisma and Supabase client interactions

**Critical Test Scenarios:**
- Successful PDF generation with all required agreement and client data
- Error handling for missing or invalid agreement IDs
- Authentication validation rejects requests without valid JWT
- PDF content validation includes signature details, client info, terms version
- Storage upload success and failure scenarios with proper cleanup
- Database transaction success for pdf_url updates
- Timeout protection and retry logic for long-running operations
- Edge Function environment compatibility and Deno runtime behavior

**Mock Data Strategy:**
- Test Agreement records with various client relationships
- Mock client records with different logo and contact configurations
- Mock Supabase Storage responses for upload success/failure
- Mock Prisma client for predictable database interactions
- Test PDF generation with various content sizes and formats
- Mock authentication contexts for testing security validation

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- .ai/debug-log.md (to be referenced during development)

### Completion Notes
- Successfully implemented complete PDF Generation Service as Supabase Edge Function
- Integrated pdf-lib library for Deno-compatible PDF generation with professional formatting
- Implemented comprehensive error handling with timeout protection (30s) and retry logic (3 attempts)
- Created robust service architecture with AgreementService, PDFGenerator, and StorageService classes
- Added full authentication validation and request parameter validation including UUID format checks
- Implemented complete test suite with unit tests, integration tests, and mocked dependencies
- PDF generation includes all required fields: company details, signature information, terms version, and audit trail
- Storage integration uses private bucket with signed URLs for secure PDF access
- Database transactions ensure atomic updates of pdf_url field after successful generation

**Definition of Done Validation:**
- ✅ All functional requirements and acceptance criteria met
- ✅ Code follows project structure and security best practices  
- ✅ Comprehensive test suite implemented with full coverage
- ✅ All story tasks completed and documented
- ✅ Ready for Review status confirmed

### File List
**New Files Created:**
- `supabase/functions/generate-pdf/index.ts` - Main Edge Function handler with authentication and orchestration
- `supabase/functions/generate-pdf/agreement-service.ts` - Database service for Agreement and Client data retrieval
- `supabase/functions/generate-pdf/pdf-generator.ts` - PDF composition logic using pdf-lib library
- `supabase/functions/generate-pdf/storage-service.ts` - Supabase Storage integration for PDF upload
- `supabase/functions/shared/cors.ts` - Shared CORS handling utility for Edge Functions
- `packages/types/pdf-generation.ts` - TypeScript interfaces for PDF generation requests/responses
- `supabase/functions/generate-pdf/__tests__/pdf-generator.test.ts` - PDF generation unit tests
- `supabase/functions/generate-pdf/__tests__/agreement-service.test.ts` - Database service unit tests  
- `supabase/functions/generate-pdf/__tests__/integration.test.ts` - Integration and end-to-end tests
- `supabase/functions/generate-pdf/deno.json` - Deno configuration for test running
- `supabase/functions/generate-pdf/test-runner.md` - Test execution documentation

**Modified Files:**
- None (all implementation in new Edge Function files)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-20 | 1.0 | Initial story creation | BMad (Scrum Master) |
| 2025-08-20 | 1.1 | Story implementation completed | James (Dev Agent) |

## QA Results

### Review Date: 2025-08-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation** of the PDF generation Edge Function with professional architecture, comprehensive error handling, and strong security practices. The code demonstrates mature patterns including proper service separation, timeout protection, retry logic, and secure authentication validation.

### Refactoring Performed

- **File**: supabase/functions/shared/cors.ts
  - **Change**: Replaced wildcard CORS origin with environment-configurable origin
  - **Why**: Wildcard CORS (`*`) poses security risk by allowing any domain to make requests
  - **How**: Uses `CORS_ORIGIN` env var with localhost fallback for development safety

### Compliance Check

- Coding Standards: ✓ Service layer pattern implemented correctly, no direct DB calls in handlers
- Project Structure: ✓ Follows Edge Function structure with proper separation of concerns
- Testing Strategy: ✓ Comprehensive test suite with unit, integration, and mock strategies
- All ACs Met: ✓ All acceptance criteria fully implemented and validated

### Improvements Checklist

[All items handled during review]

- [x] Fixed CORS security vulnerability (supabase/functions/shared/cors.ts)
- [x] Verified comprehensive timeout and retry mechanisms
- [x] Validated proper UUID format checking
- [x] Confirmed atomic database transactions
- [x] Verified secure private storage with signed URLs

### Security Review

**Strong security implementation:**
- JWT authentication validation before processing
- UUID format validation prevents injection attacks
- Private storage bucket with signed URLs (1-year expiry)
- No sensitive data logging
- Proper error message sanitization
- Environment-configurable CORS (fixed during review)

### Performance Considerations

**Well-optimized for Edge Function environment:**
- 30-second timeout protection for PDF generation
- Exponential backoff retry logic (max 3 attempts)
- Efficient PDF generation using pdf-lib library
- Proper database connection cleanup
- Minimal memory footprint with streaming operations

### Files Modified During Review

- `supabase/functions/shared/cors.ts` - Enhanced CORS security configuration

### Gate Status

Gate: PASS → docs/qa/gates/2.4-pdf-generation-service-edge-function.yml

### Recommended Status

✓ Ready for Done - Implementation exceeds requirements with professional-grade architecture and security