# Story 2.5: Asynchronous PDF Generation Trigger

## Status

Done

## Story

**As a** System,
**I want** to trigger PDF generation asynchronously and reliably,
**so that** the client-facing UI is not blocked and failures are handled.

## Acceptance Criteria

1. The PDF generation function is invoked immediately after signature persistence
2. The UI transitions to a loading state
3. The function includes a timeout of 10 seconds and an auto-retry policy (3 attempts with exponential backoff) for transient errors

## Tasks / Subtasks

- [x] Implement asynchronous PDF generation trigger after signature persistence (AC: 1)
  - [x] Create service function to invoke PDF generation Edge Function
  - [x] Integrate trigger into signature persistence server action workflow
  - [x] Add proper error handling for Edge Function invocation failures
  - [x] Ensure Edge Function is called immediately after Agreement record creation
  - [x] Add logging for PDF generation trigger events

- [x] Implement UI loading state management (AC: 2)
  - [x] Add loading state to signature form component
  - [x] Create loading UI with progress indicator during PDF generation
  - [x] Handle state transitions from signature -> loading -> confirmation
  - [x] Add loading timeout protection for UI responsiveness
  - [x] Implement graceful fallback for loading state errors

- [x] Add timeout and retry mechanisms (AC: 3)
  - [x] Configure 10-second timeout for PDF generation function calls
  - [x] Implement exponential backoff retry logic (3 attempts)
  - [x] Add retry delay calculation (1s, 2s, 4s intervals)
  - [x] Handle maximum retry attempts reached scenarios
  - [x] Log retry attempts and final success/failure status

- [x] Implement comprehensive error handling (AC: 1, 3)
  - [x] Handle Edge Function network failures and timeouts
  - [x] Create user-friendly error messages for PDF generation failures
  - [x] Add fallback mechanism for persistent PDF generation failures
  - [x] Ensure Agreement record remains valid even if PDF generation fails
  - [x] Implement error reporting for debugging and monitoring

- [x] Add server action integration (AC: 1, 2)
  - [x] Modify signature persistence server action to trigger PDF generation
  - [x] Add proper error boundaries for PDF generation failures
  - [x] Ensure atomic database operations with PDF generation trigger
  - [x] Handle edge cases where signature succeeds but PDF generation fails
  - [x] Return appropriate response states for UI state management

- [x] Unit tests for asynchronous PDF generation logic (Testing Standards)
  - [x] Test successful PDF generation trigger after signature persistence
  - [x] Test timeout handling with 10-second limit
  - [x] Test retry logic with exponential backoff (3 attempts)
  - [x] Test error handling for various Edge Function failure scenarios
  - [x] Test UI loading state transitions and timeout protection
  - [x] Test atomic database operations with PDF generation integration
  - [x] Mock Edge Function responses for predictable testing

## Dev Notes

### Previous Story Insights

Story 2.4 successfully implemented the complete PDF Generation Service as a Supabase Edge Function with comprehensive error handling, timeout protection (30s), and retry logic (3 attempts). The Edge Function is ready to be invoked and includes:
- Authentication validation and request parameter validation
- Professional PDF generation with all required signature and client details  
- Robust service architecture with timeout protection and retry mechanisms
- Secure storage integration with private bucket and signed URLs
- Database transactions ensuring atomic updates of pdf_url field

The Edge Function endpoint is available at `POST /functions/v1/generate-pdf` and expects `{ "agreementId": "uuid" }` with Supabase JWT authentication.

### Data Models

[Source: architecture/4-data-models.md]
**Agreement Model:** The trigger will work with Agreement records created by signature persistence:
- `id`: string (UUID) - Will be passed as agreementId to PDF generation function
- `client_id`: string (UUID) - Used by PDF function to fetch Client relationship data
- `pdf_url`: string | null - Will be populated by PDF generation function upon success
- `signed_at`: Date - Signature timestamp already recorded by signature persistence
- `signer_name`: string - Signer details already captured for PDF content
- `signer_ip`: string - IP address already recorded for PDF audit trail

**Client Model:** Related data already available for PDF generation:
- Client data is already associated through `client_id` foreign key relationship
- All client details (company_name, contact_name, logo_url) are available for PDF content

### API Specifications

[Source: architecture/5-api-specification.md]
**PDF Generation Function Call:**
- **Endpoint:** `POST /functions/v1/generate-pdf` (Edge Function)
- **Auth:** Supabase user JWT required for security
- **Request Body:** `{ "agreementId": "uuid" }` - Agreement ID from signature persistence
- **Success Response:** `{ "pdfUrl": "https://.../agreements/..." }`
- **Error Response:** `{ "error": "PDF generation failed", "details": "..." }`

**Server Action Integration:** The trigger will be integrated into the existing signature persistence server action, ensuring the PDF generation is initiated immediately after successful Agreement creation.

### Core Workflow Integration

[Source: architecture/8-core-workflows.md]
This story implements the asynchronous trigger portion of **Workflow 2: Client Activates Agreement**:
```
App->>DB: Create agreement + update status
par
  App->>PDF: Invoke generate-pdf (Story 2.5 - This Story)
  PDF->>Storage: Save PDF
  Storage-->>PDF: Return pdf_url  
  PDF->>DB: Update agreement with pdf_url
  PDF-->>App: Success
  App->>Client: Show confirmation + download
```

The trigger ensures:
1. PDF generation is invoked immediately after Agreement creation
2. UI shows loading state while PDF generation is in progress
3. Timeout and retry mechanisms handle transient failures gracefully
4. User experience remains smooth with proper error handling

### Backend Architecture

[Source: architecture/11-backend-architecture-selected-highlights.md]
**Service Layer Pattern:** The PDF generation trigger will follow the established service layer pattern, with no direct Edge Function calls in UI components. A dedicated service function will handle the Edge Function invocation with proper error handling and retry logic.

**Function Integration:** The trigger will use the existing Edge Function template pattern with proper CORS handling and JSON responses, leveraging the shared utilities already implemented in Story 2.4.

### File Locations

[Source: architecture/12-unified-project-structure.md]
Based on the monorepo structure, the trigger implementation will be located:
```
apps/
  web/
    src/
      lib/
        services/
          pdf-generation-service.ts         # New: PDF generation trigger service
      app/
        activate/
          [token]/
            signature-form.tsx              # Modified: Add loading state integration
        actions/
          signature-actions.ts              # Modified: Add PDF generation trigger
packages/
  types/
    pdf-generation.ts                       # Existing: Use existing PDF interfaces
```

### Technical Constraints

[Source: architecture/3-tech-stack.md]
- **Frontend Framework:** Next.js ~14.2 with App Router for server actions integration
- **Backend Language:** TypeScript with Deno for Edge Function compatibility
- **State Management:** React Context/Hooks for UI loading state management
- **Authentication:** Supabase Auth JWT tokens for Edge Function authentication
- **Deployment:** Vercel platform for seamless server action and Edge Function integration

### Timeout and Retry Configuration

**Story-Specific Requirements:**
- **Timeout:** 10 seconds (as specified in AC 3) - Note: This is different from the 30-second timeout in the Edge Function itself
- **Retry Policy:** 3 attempts with exponential backoff (1s, 2s, 4s intervals)
- **Error Handling:** Graceful degradation where signature persistence succeeds even if PDF generation fails
- **UI Protection:** Loading state timeout to prevent infinite loading scenarios

### Security Requirements

[Source: architecture/17-coding-standards.md]
**Authentication:** The trigger service must pass valid Supabase JWT tokens when calling the PDF generation Edge Function
**Service Layer Pattern:** No direct Edge Function calls in UI components; use dedicated service layer for PDF generation triggers
**Error Sanitization:** Ensure PDF generation errors are properly sanitized before displaying to users

### Project Structure Notes

The asynchronous trigger will integrate seamlessly with the existing signature persistence workflow from Story 2.3 and will invoke the PDF generation Edge Function from Story 2.4. The implementation follows the established server action pattern and maintains separation of concerns between UI state management and backend service calls.

## Testing

### Testing Standards

[Source: architecture/16-testing-strategy.md]
- **Testing Framework:** Jest + React Testing Library for component and service unit tests
- **Test File Location:** `apps/web/src/__tests__/` following Next.js testing patterns
- **Setup:** Next.js 14 Jest configuration with jsdom environment

**Test Types Required:**
- Unit tests for PDF generation trigger service logic
- Component tests for loading state UI transitions
- Integration tests for server action with PDF generation trigger
- Error handling tests for timeout and retry scenarios
- Mock tests for Edge Function responses and network failures

**Critical Test Scenarios:**
- Successful PDF generation trigger after signature persistence
- UI loading state transitions (signature -> loading -> confirmation)
- Timeout handling with 10-second limit and UI protection
- Retry logic with exponential backoff (3 attempts with 1s, 2s, 4s delays)
- Error handling for various Edge Function failure scenarios
- Atomic database operations ensuring signature persistence succeeds regardless of PDF generation status
- Authentication token passing to Edge Function calls
- Network failure scenarios and graceful degradation

**Mock Data Strategy:**
- Mock Edge Function responses for success, timeout, and failure scenarios
- Test Agreement records with various client relationships
- Mock Supabase client for predictable authentication and function calls
- Simulated network conditions for timeout and retry testing
- Mock loading states and UI state transitions

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- .ai/debug-log.md - Story 2.5 implementation details and issues resolved

### Completion Notes
- Successfully implemented asynchronous PDF generation trigger with timeout and retry logic
- Added comprehensive error handling ensuring signature persistence succeeds even if PDF fails
- Implemented loading state UI with animated indicators and timeout protection
- Created extensive unit tests covering all scenarios including failures and edge cases
- Fixed TypeScript file extension issue (use-toast.ts -> use-toast.tsx) discovered during validation
- All acceptance criteria met with robust implementation

### File List
**Created:**
- apps/web/src/lib/services/pdf-generation-service.ts
- apps/web/src/lib/services/__tests__/pdf-generation-service.test.ts
- apps/web/src/app/activate/[token]/components/__tests__/activation-form-pdf.test.tsx
- .ai/debug-log.md

**Modified:**
- apps/web/src/actions/signature-actions.ts
- apps/web/src/app/activate/[token]/components/activation-form.tsx
- apps/web/src/actions/__tests__/signature-actions.test.ts
- apps/web/src/app/activate/[token]/components/activation-page-content.tsx (fixed syntax)
- apps/web/src/hooks/use-toast.ts -> use-toast.tsx (renamed for JSX support)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-20 | 1.0 | Initial story creation | BMad (Scrum Master) |
| 2025-08-20 | 1.1 | Completed implementation | James (Dev) |

## QA Results

### Review Date: 2025-08-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCELLENT** - This implementation demonstrates robust asynchronous service architecture with comprehensive error handling, timeout protection, and retry logic. The PDF generation trigger successfully integrates with the signature persistence workflow while maintaining clean separation of concerns and ensuring signature success even when PDF generation fails.

### Refactoring Performed

**Security & Robustness Enhancement**: Added environment variable validation and input sanitization

- **File**: apps/web/src/lib/services/pdf-generation-service.ts
  - **Change**: Added validation for NEXT_PUBLIC_SUPABASE_URL environment variable
  - **Why**: Prevents runtime failures with clear error messages when environment is misconfigured
  - **How**: Check environment variable exists before attempting API calls

- **File**: apps/web/src/lib/services/pdf-generation-service.ts  
  - **Change**: Added input validation for agreement ID parameter
  - **Why**: Prevents invalid API calls and provides immediate feedback for invalid inputs
  - **How**: Validate string type, non-empty, and non-whitespace before processing

**Test Coverage Enhancement**: Added comprehensive edge case testing

- **File**: apps/web/src/lib/services/__tests__/pdf-generation-service.test.ts
  - **Change**: Added tests for input validation and environment variable handling
  - **Why**: Ensures robustness against configuration errors and invalid inputs
  - **How**: Test cases for empty strings, null/undefined inputs, and missing environment variables

### Compliance Check

- Coding Standards: ✓ **EXCELLENT** - Follows async/await patterns, proper error handling, and TypeScript best practices
- Project Structure: ✓ **EXCELLENT** - Perfect service layer separation with clean integration points
- Testing Strategy: ✓ **EXCELLENT** - Comprehensive test coverage including timeout, retry, and failure scenarios  
- All ACs Met: ✓ **PERFECT** - All three acceptance criteria fully implemented and tested

### Improvements Checklist

[All items handled during review - excellent baseline implementation]

- [x] Enhanced input validation for robust error handling (pdf-generation-service.ts)
- [x] Added environment variable validation for deployment safety (pdf-generation-service.ts)
- [x] Expanded test coverage for edge cases and configuration errors (test file updated)
- [x] Verified async fire-and-forget pattern doesn't block signature flow
- [x] Confirmed exponential backoff retry logic works correctly (1s, 2s, 4s)
- [x] Validated 10-second timeout matches acceptance criteria requirements
- [x] Verified proper JWT authentication handling for Edge Function calls

### Security Review

**PASS WITH DISTINCTION** - Secure Service Integration

✓ **Authentication Security**: Proper JWT token validation before Edge Function calls  
✓ **Environment Security**: Secure environment variable handling with validation  
✓ **Input Validation**: Comprehensive agreement ID validation prevents malformed requests  
✓ **Error Sanitization**: PDF errors properly isolated from signature persistence flow  
✓ **Resource Management**: Proper timeout cleanup prevents resource leaks  
✓ **Separation of Concerns**: UI components isolated from direct Edge Function calls

### Performance Considerations

**EXCELLENT** - Optimal Async Architecture

✓ **Non-Blocking Design**: PDF generation doesn't block signature persistence or UI response  
✓ **Timeout Protection**: 10-second timeout prevents hanging operations  
✓ **Retry Efficiency**: Exponential backoff (1s, 2s, 4s) balances responsiveness and load  
✓ **Resource Management**: AbortController properly cancels timed-out requests  
✓ **UI Responsiveness**: Loading state management with timeout protection  
✓ **Graceful Degradation**: Agreement remains valid even if PDF generation fails

### Files Modified During Review

- apps/web/src/lib/services/pdf-generation-service.ts (added input validation and environment checks)
- apps/web/src/lib/services/__tests__/pdf-generation-service.test.ts (added edge case test coverage)

### Gate Status

Gate: **PASS** → docs/qa/gates/2.5-asynchronous-pdf-generation-trigger.yml  
Quality Score: **98/100** - Excellent implementation with minor enhancements  
Risk Profile: Medium risk - External service dependencies with robust error handling

### Recommended Status

✓ **Ready for Done** - Implementation meets all requirements with excellent error handling and security posture