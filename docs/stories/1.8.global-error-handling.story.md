# Story 1.8: Global Error Handling

## Status

Done

## Story

**As a** user,
**I want** to see a clear and helpful error page when something goes wrong,
**so that** I am not left with a broken screen.

## Acceptance Criteria

1. A global error boundary is implemented in the Next.js App Router
2. A standardized error page is displayed for unhandled exceptions
3. UI toasts are used for non-critical errors

## Tasks / Subtasks

- [x] Implement global error boundary component (AC: 1)
  - [x] Create error boundary component using React error boundary pattern
  - [x] Add error boundary to Next.js App Router layout structure
  - [x] Implement error logging with correlation IDs for debugging
  - [x] Ensure error boundary follows standard error shape `{ code, message, details? }`

- [x] Create standardized error page (AC: 2)
  - [x] Design error page component with consistent branding
  - [x] Add error message display with helpful information
  - [x] Include retry/refresh functionality for recoverable errors
  - [x] Implement fallback UI for different error types
  - [x] Add navigation back to safe routes (dashboard/login)

- [x] Implement UI toast system for non-critical errors (AC: 3)
  - [x] Create toast component using ShadCN/UI patterns
  - [x] Add toast provider to app layout
  - [x] Implement different toast variants (error, warning, info, success)
  - [x] Add toast display logic for service layer errors
  - [x] Integrate toasts with existing error handling in components

- [x] Integrate error handling throughout the application (AC: 1, 2, 3)
  - [x] Update auth service to use toast notifications for auth errors
  - [x] Update client service to handle API errors with appropriate UI feedback
  - [x] Add error boundaries around route groups (auth), (dashboard)
  - [x] Handle Supabase client errors gracefully with user-friendly messages
  - [x] Ensure real-time connection errors show appropriate feedback

- [x] Write unit tests for error handling components (Testing Requirements)
  - [x] Test error boundary component with thrown errors
  - [x] Test error page rendering and navigation functionality
  - [x] Test toast component variants and display logic
  - [x] Test error service integration with UI components
  - [x] Mock error scenarios for predictable testing

## Dev Notes

### Previous Story Insights

Story 1.7 successfully implemented real-time dashboard updates. The application now has a solid foundation with authentication, dashboard functionality, client management, and real-time updates. The error handling story builds upon this foundation to provide a robust user experience when errors occur, ensuring users are never left with broken or unresponsive screens.

### Data Models

No specific database schema changes required for this story. Error handling is primarily a frontend/UI enhancement that works with existing data models.

[Source: architecture/18-error-handling-strategy.md]
**Standard Error Shape:**
All errors should follow the standardized format:
```typescript
interface ApplicationError {
  code: string;
  message: string;
  details?: any;
}
```

### API Specifications

[Source: architecture/18-error-handling-strategy.md]
**Error Logging Strategy:**
- Correlation IDs in edge functions for tracking
- Log errors to Supabase for debugging
- Maintain standard error shape for consistent handling

**Error Boundary Integration:**
- Global error boundaries capture unhandled React errors
- Route-level error boundaries for granular error handling
- Service layer errors propagated through proper error channels

### Component Specifications

[Source: architecture/10-frontend-architecture-selected-highlights.md]
**Component Organization:**
- Error components in `components/ui/` for reusable error UI
- Error boundaries in `app/` layout structure for route protection
- Toast components following ShadCN/UI patterns

[Source: architecture/6-components.md]
**Frontend Component Integration:**
- Error handling integrated with existing authentication UI
- Dashboard UI enhanced with error feedback mechanisms
- Activation UI protected with error boundaries

[Source: architecture/18-error-handling-strategy.md]
**UI Error Strategy:**
- UI toasts for non-critical errors (validation, network issues)
- Error boundaries around routes for unhandled exceptions
- Standardized error pages for application-level failures

### File Locations

[Source: architecture/12-unified-project-structure.md]
Based on the unified project structure, new files needed:
```
apps/web/src/
  app/
    error.tsx                           # Global error page for app router
    layout.tsx                          # Update to include toast provider
    (auth)/
      error.tsx                         # Auth-specific error boundary
    (dashboard)/
      error.tsx                         # Dashboard-specific error boundary
  components/
    ui/
      toast.tsx                         # Toast notification component
      error-boundary.tsx                # Reusable error boundary component
      error-page.tsx                    # Standardized error page component
  lib/
    error-service.ts                    # Error handling service layer
  hooks/
    use-toast.ts                        # Custom hook for toast management
```

**Existing Files to Modify:**
- `apps/web/src/lib/auth-service.ts` - Add error handling integration
- `apps/web/src/lib/client-service.ts` - Add toast error notifications
- `apps/web/src/app/(dashboard)/dashboard/page.tsx` - Integrate error feedback

### Testing Requirements

[Source: architecture/16-testing-strategy.md]
- **Testing Framework:** Jest ~29.7 + React Testing Library
- **Test File Location:** `apps/web/src/**/__tests__/` or co-located with components
- **Mock Strategy:**
  - Mock React error boundary lifecycle methods
  - Mock toast notification system for predictable testing
  - Simulate component errors to test error boundary behavior
  - Mock service layer errors for toast integration testing
- **Test Coverage Required:**
  - Error boundary component error capture and display
  - Error page navigation and retry functionality
  - Toast component variants and auto-dismiss behavior
  - Service integration with error handling
  - Error correlation ID generation and logging

### Technical Constraints

[Source: architecture/3-tech-stack.md]
- **Frontend Framework:** Next.js ~14.2 with App Router
- **UI Components:** ShadCN/UI for consistent component styling
- **State Management:** React Context/Hooks for error state management
- **Error Boundaries:** React 18 error boundary patterns

**Next.js App Router Constraints:**
- Error boundaries must be client components
- Global error handling via `error.tsx` files in app directory
- Server component errors handled differently than client component errors

### Security Requirements

[Source: architecture/18-error-handling-strategy.md]
- Error messages must not expose sensitive data or internal system details
- Correlation IDs for debugging without revealing system architecture
- Error logging must exclude sensitive user information
- Client-side error display should be user-friendly without technical details

### Performance Considerations

**Error Handling Performance:**
- Error boundaries should not impact normal application performance
- Toast notifications should be lightweight and non-blocking
- Error logging should be asynchronous to avoid blocking UI
- Error pages should load quickly even when the main application has issues

### Coding Standards

[Source: architecture/17-coding-standards.md]
- Service layer pattern: Error handling integrated into existing service layer
- Hooks prefix `use*` for custom error handling hooks
- ESLint + Prettier enforced for code consistency
- Component-based architecture with proper separation of concerns

### Error Handling Strategy Details

[Source: architecture/18-error-handling-strategy.md]
**Implementation Requirements:**
- Standard error shape `{ code, message, details? }` for all errors
- UI toasts for recoverable errors (network, validation)
- Error boundaries around routes for unhandled exceptions
- Correlation IDs in edge functions with Supabase logging
- User-friendly error messages without technical exposure

### Project Structure Notes

The existing Next.js App Router structure provides the foundation for implementing error boundaries at the appropriate levels. The authentication and dashboard route groups are already established, making it straightforward to add error boundaries at each level. The ShadCN/UI component library provides styling patterns that can be extended for error components. All file locations align with the established project structure.

## Testing

### Testing Standards

[Source: architecture/16-testing-strategy.md]
- **Testing Framework:** Jest ~29.7 + React Testing Library
- **Test File Location:** `apps/web/src/**/__tests__/` or co-located with components
- **Setup:** Jest config already exists at `apps/web/jest.config.ts`
- **Mock Strategy:**
  - Mock React error boundary methods (componentDidCatch, getDerivedStateFromError)
  - Mock toast provider and notification system
  - Simulate component errors using test utilities
  - Mock service layer error responses for integration testing
- **Test Types Required:**
  - Unit tests for error boundary components
  - Component tests for error page rendering and navigation
  - Integration tests for toast notifications with service errors
  - Error handling tests for auth and client services
- **CI Integration:** Tests run in GitHub Actions workflow
- **Coverage Requirements:** All new error handling functionality must have unit tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-20 | 1.0 | Initial story creation | BMad Agent (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Implementation Summary
Successfully implemented comprehensive global error handling system across the Next.js application with the following components:

**Error Boundary System:**
- Global error boundary component with React error boundary pattern
- Route-specific error boundaries for (auth) and (dashboard) route groups
- Correlation ID logging for debugging and error tracking
- Custom fallback UI components with consistent branding
- Development mode error details display

**Toast Notification System:**
- Complete toast component system using ShadCN/UI patterns
- Toast provider with context-based state management
- Multiple variants: success, error, warning, info, default
- Auto-dismiss functionality with configurable duration
- Helper hooks for easy toast usage throughout app

**Error Service Layer:**
- Centralized error service with standardized error shapes
- User-friendly error message mapping
- Comprehensive error code definitions for all application domains
- Error logging with correlation IDs and context information
- Singleton pattern for consistent error handling

**Integration Implementation:**
- Enhanced auth service with error handling and toast notifications
- Updated client service with comprehensive error handling
- Dashboard integration with real-time connection error feedback
- Login page integration with authentication error handling
- Client creation modal with upload and creation error handling

### File List
**New Files Created:**
- `apps/web/src/components/ui/error-boundary.tsx` - React error boundary component
- `apps/web/src/components/ui/error-page.tsx` - Standardized error page component
- `apps/web/src/components/ui/toast.tsx` - Toast notification component
- `apps/web/src/components/ui/toast-container.tsx` - Toast display container
- `apps/web/src/hooks/use-toast.ts` - Toast context and helper hooks
- `apps/web/src/lib/error-service.ts` - Centralized error handling service
- `apps/web/src/app/error.tsx` - Global error page for App Router
- `apps/web/src/app/(auth)/error.tsx` - Auth route error boundary
- `apps/web/src/app/(dashboard)/error.tsx` - Dashboard route error boundary

**Test Files Created:**
- `apps/web/src/components/ui/__tests__/error-boundary.test.tsx`
- `apps/web/src/components/ui/__tests__/error-page.test.tsx`
- `apps/web/src/components/ui/__tests__/toast.test.tsx`
- `apps/web/src/components/ui/__tests__/toast-container.test.tsx`
- `apps/web/src/hooks/__tests__/use-toast.test.tsx`
- `apps/web/src/lib/__tests__/error-service.test.ts`

**Modified Files:**
- `apps/web/src/app/layout.tsx` - Added toast provider and container
- `apps/web/src/lib/auth-service.ts` - Enhanced with error handling and logging
- `apps/web/src/lib/client-service.ts` - Enhanced with error handling and user-friendly messages
- `apps/web/src/app/(auth)/login/page.tsx` - Added toast notifications for auth errors
- `apps/web/src/app/(dashboard)/dashboard/page.tsx` - Added connection status and error handling
- `apps/web/src/app/(dashboard)/dashboard/components/client-creation-modal.tsx` - Enhanced error handling

### Debug Log References
All error handling implementations include comprehensive logging with correlation IDs:
- Error boundary errors logged with `err_` prefix
- Auth service errors logged with context information
- Client service errors logged with sanitized details
- Service layer errors propagated with user-friendly messages
- Development mode detailed error display for debugging

### Completion Notes
- All acceptance criteria fully implemented and tested
- Error boundaries protect all route levels (global, auth, dashboard)
- Toast system provides user-friendly feedback for non-critical errors
- Service layer enhanced with standardized error handling
- Comprehensive test coverage for all new components
- Integration complete across all existing functionality
- Ready for QA review and testing

### Change Log
| Date | Change | Details |
|------|--------|---------|
| 2025-08-20 | Initial Implementation | Created error boundary system with React patterns |
| 2025-08-20 | Toast System | Implemented complete toast notification system |
| 2025-08-20 | Error Service | Created centralized error handling service |
| 2025-08-20 | Service Integration | Enhanced auth and client services with error handling |
| 2025-08-20 | UI Integration | Added error handling to dashboard and login pages |
| 2025-08-20 | Testing | Created comprehensive unit tests for all components |
| 2025-08-20 | Documentation | Updated story file with implementation details |

## QA Results

### Review Date: 2025-08-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of comprehensive global error handling system with robust architecture and good separation of concerns. The error boundary system properly captures React errors at multiple levels, the toast notification system provides effective user feedback, and the centralized error service ensures consistent error handling throughout the application. The implementation properly follows React error boundary patterns, includes comprehensive testing, and integrates well with the existing codebase architecture. TypeScript interfaces are well-defined and the component organization follows established project patterns.

### Refactoring Performed

- **File**: apps/web/src/lib/error-service.ts
  - **Change**: Enhanced error logging with input validation and sensitive data sanitization
  - **Why**: Prevents runtime errors from invalid inputs and protects against accidental logging of sensitive information
  - **How**: Added null checks, default context values, and field-based sanitization for common sensitive patterns

- **File**: apps/web/src/lib/error-service.ts
  - **Change**: Improved correlation ID generation consistency and createError validation
  - **Why**: Ensures reliable ID generation and prevents invalid error objects
  - **How**: Replaced substr with substring for better compatibility and added input validation

- **File**: apps/web/src/hooks/use-toast.ts
  - **Change**: Added toast queue limit and input validation for toast helpers
  - **Why**: Prevents memory leaks from excessive toasts and handles empty/invalid toast messages
  - **How**: Limited maximum toasts to 5 and added title validation with trimming

- **File**: apps/web/src/components/ui/toast.tsx
  - **Change**: Enhanced accessibility with ARIA attributes for screen readers
  - **Why**: Improves accessibility for users with assistive technologies
  - **How**: Added role="alert" and dynamic aria-live attributes based on toast variant

- **File**: Multiple error boundary files
  - **Change**: Standardized correlation ID generation across all error boundaries
  - **Why**: Ensures consistent error tracking and debugging capabilities
  - **How**: Replaced substr with substring for uniform ID format across application

### Compliance Check

- Coding Standards: ✓ Service layer pattern followed, hooks properly named with 'use*' prefix, ESLint compatible
- Project Structure: ✓ Files organized correctly in app/ and components/ui/ per unified structure
- Testing Strategy: ✓ Comprehensive unit tests for all error handling components and services
- All ACs Met: ✓ Global error boundary implemented, standardized error pages, UI toasts for non-critical errors

### Improvements Checklist

- [x] Enhanced error service with input validation and sanitization (error-service.ts)
- [x] Improved toast system with queue limits and validation (use-toast.ts)
- [x] Added accessibility improvements to toast components (toast.tsx)
- [x] Standardized correlation ID generation across error boundaries (error.tsx files)
- [x] Validated comprehensive test coverage for all error handling scenarios
- [ ] Consider implementing error rate limiting to prevent error spam
- [ ] Add telemetry integration for error monitoring in production
- [ ] Consider implementing error recovery strategies for specific error types

### Security Review

✓ **Sensitive Data Protection**: Added sanitization to prevent accidental logging of passwords, tokens, and credentials
✓ **Error Information**: Error messages are user-friendly without exposing internal system details
✓ **Correlation IDs**: Safe for debugging without revealing system architecture
✓ **Input Validation**: Added validation to prevent invalid error objects and malformed data
✓ **Memory Safety**: Toast queue limits prevent memory leaks from excessive notifications

### Performance Considerations

✓ **Error Boundary Overhead**: Minimal performance impact on normal application operation
✓ **Toast Performance**: Queue limits and auto-dismiss prevent memory accumulation
✓ **Error Logging**: Asynchronous logging patterns don't block UI interactions
✓ **Component Optimization**: React optimization patterns with useCallback and useMemo
✓ **Memory Management**: Proper cleanup of timeouts and subscriptions

### Files Modified During Review

- apps/web/src/lib/error-service.ts (input validation, sanitization, correlation ID improvement)
- apps/web/src/hooks/use-toast.ts (queue limits, input validation)
- apps/web/src/components/ui/toast.tsx (accessibility improvements)
- apps/web/src/components/ui/error-boundary.tsx (correlation ID consistency)
- apps/web/src/app/error.tsx (correlation ID consistency)
- apps/web/src/app/(dashboard)/error.tsx (correlation ID consistency)

### Gate Status

Gate: PASS → docs/qa/gates/1.8-global-error-handling.yml

### Recommended Status

✓ Ready for Done - All acceptance criteria successfully implemented with comprehensive error handling system, excellent test coverage, security improvements, and performance optimizations applied.