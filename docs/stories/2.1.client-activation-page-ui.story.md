# Story 2.1: Client Activation Page UI

## Status

Draft

## Story

**As a** Client,
**I want** to see a professional and personalized page when I open my activation link,
**so that** I feel confident in the process.

## Acceptance Criteria

1. A valid `/activate/<token>` URL renders a page displaying the correct client's company name and terms
2. An invalid token shows a generic error page

## Tasks / Subtasks

- [ ] Create activation page route structure (AC: 1)
  - [ ] Create `app/activate/[token]/page.tsx` route using Next.js App Router
  - [ ] Set up dynamic route parameter handling for token validation
  - [ ] Implement server component for initial token validation
  - [ ] Configure proper metadata for SEO and sharing

- [ ] Implement token validation and client data fetching (AC: 1, 2)
  - [ ] Create service layer function to validate activation token
  - [ ] Implement client data fetching by token with RLS policies
  - [ ] Handle token expiry (24-hour expiry mechanism)
  - [ ] Add proper error handling for database connection issues

- [ ] Design and implement activation page UI (AC: 1)
  - [ ] Create responsive activation page layout using Tailwind CSS
  - [ ] Display client company name and logo prominently
  - [ ] Present terms and conditions in readable format
  - [ ] Implement professional design matching ShadCN/UI patterns
  - [ ] Add loading states for data fetching

- [ ] Implement error page for invalid tokens (AC: 2)
  - [ ] Create generic error page component
  - [ ] Handle various error scenarios (invalid token, expired token, database errors)
  - [ ] Provide helpful error messages without exposing sensitive information
  - [ ] Add navigation back to main site or contact information

- [ ] Unit tests for activation page components and logic (Testing Standards)
  - [ ] Test token validation logic with valid and invalid tokens
  - [ ] Test client data fetching with different scenarios
  - [ ] Test error handling and error page rendering
  - [ ] Test responsive design across different screen sizes

## Dev Notes

### Previous Story Insights

Story 1.11 successfully implemented comprehensive domain configuration with professional-grade infrastructure. The application now has solid deployment foundations with proper domain access that will inspire client confidence. This story builds upon that infrastructure to deliver the first client-facing experience - the activation page that clients will see when they receive their unique activation links.

### Data Models

[Source: architecture/4-data-models.md]
**Client Model:** The activation page will need to fetch client data including:
- `id`: string (UUID) - Unique identifier for the client
- `company_name`: string - Display prominently on activation page
- `contact_name`: string - Primary contact person's name  
- `email`: string - Primary contact's email address
- `role_title`: string - Contact's job title or role
- `logo_url`: string | null - Company logo URL from Supabase Storage
- `status`: 'pending' | 'activated' - Must be 'pending' for activation
- `created_by`: string (UUID) - Operator who created the record
- `created_at`: Date - When the record was created

**Token Mechanism:** Based on Story 1.6 implementation, activation tokens:
- Generated using `crypto.randomUUID()`
- Stored in the `clients` table
- Include 24-hour expiry mechanism
- Used in URL format: `/activate/<token>`

### API Specifications

[Source: architecture/12-unified-project-structure.md]
**RLS Policies:** Anonymous clients may `select` activation record by token via RPC with token verification

**Database Access Pattern:**
- Use service layer for Supabase calls (no direct calls in components)
- Token validation should use RPC function for security
- Client data fetching must respect RLS policies for anonymous access

### Component Specifications

[Source: architecture/10-frontend-architecture-selected-highlights.md]
**Component Organization:**
- Page components in `app/activate/[token]/page.tsx` (App Router)
- Reusable UI components in `components/ui/`
- Composed components in `components/composed/`
- Page-specific components in `app/activate/[token]/components/`

**Template Pattern:** Use `PageHeader` with `cn()` utility for consistent styling
**State Management:** React hooks + TanStack Query for data fetching
**Protected Routes:** Route handled via `middleware.ts` but activation pages should be publicly accessible

[Source: architecture/6-components.md]
**Client Activation UI Component:** Part of the Frontend Components that invokes core BaaS services

### File Locations

[Source: architecture/12-unified-project-structure.md]
Based on the unified project structure:
```
apps/web/                           # Next.js 14 App Router
  app/activate/[token]/
    page.tsx                        # Main activation page
    loading.tsx                     # Loading component
    error.tsx                       # Error boundary component
    components/                     # Page-specific components
      activation-form.tsx
      client-header.tsx
  src/lib/
    services/activation.ts          # Activation service layer
  src/components/ui/                # ShadCN/UI components
  src/components/composed/          # Composed components
```

### Technical Constraints

[Source: architecture/3-tech-stack.md]
- **Frontend Framework:** Next.js ~14.2 with App Router
- **UI Component Library:** ShadCN/UI Latest for accessible, unstyled components
- **Styling:** Tailwind CSS ~3.4 for utility-first CSS framework
- **State Management:** React Context/Hooks sufficient for MVP scope
- **Backend Platform:** Supabase ~1.180 for database and auth
- **ORM:** Prisma ~5.15 for type-safe database access

**Route Structure:** Use App Router with `activate/[token]` dynamic route groups

### Security Requirements

[Source: architecture/12-unified-project-structure.md]
**Storage Security:**
- `logos` bucket: public-read access for displaying company logos
- Anonymous access to client records via token validation only
- No sensitive information exposed in error messages

**RLS Policies:** Anonymous clients can only access client data through valid token verification

### Core Workflow Integration

[Source: architecture/8-core-workflows.md]
This story implements the beginning of **Workflow 2: Client Activates Agreement**:
```
Client->>App: Opens activation link
App->>DB: Fetch client by token  
DB-->>App: Return client data
```

The activation page must handle the initial client access and data display before proceeding to the signature collection phase in subsequent stories.

### Project Structure Notes

The existing Next.js App Router structure aligns perfectly with the activation page requirements. The route structure `app/activate/[token]/page.tsx` follows Next.js conventions and integrates well with the existing authentication middleware. The service layer pattern from previous stories should be maintained for database interactions.

## Testing

### Testing Standards

[Source: architecture/16-testing-strategy.md]
- **Testing Framework:** Jest ~29.7 + React Testing Library for unit tests
- **E2E Testing:** Playwright ~1.44 for end-to-end testing  
- **Test File Location:** `apps/web/src/**/__tests__/` or co-located with components
- **Setup:** Jest config at `apps/web/jest.config.ts`, Playwright config at `playwright.config.ts`

**Test Types Required:**
- Unit tests for activation page components and token validation logic
- Integration tests for client data fetching and error handling
- E2E tests for complete activation page flow
- Responsive design tests across different screen sizes

**Critical Test Scenarios:**
- Valid token displays correct client information and terms
- Invalid token shows appropriate error page
- Expired token handles gracefully with proper error message
- Database connection failures display user-friendly error
- Mobile responsiveness across different devices

**Mock Data Strategy:**
- Test client records with various company names and logos
- Mock token validation service responses
- Simulate different error conditions (network, database, invalid tokens)
- Test data should include both valid and edge case scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-20 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by development agent_

### Debug Log References

_To be filled by development agent_

### Completion Notes

_To be filled by development agent_

### File List

_To be filled by development agent_

## QA Results

_To be filled by QA agent during review_